<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/Blog">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <link rel="stylesheet" href="https://cyborgdream.github.io/site.css">
  <title>Do cyborgs dream of bionic sheep? - More C++ concurrency</title>
  
  

  <meta name="description" itemprop="about" content="">
  <meta name="keywords" itemprop="keywords" content="zola, theme, retro, hacking">
  <meta name="author" itemprop="author" content="Mari-chan">
  <meta itemprop="headline" content="Do cyborgs dream of bionic sheep?">
  <meta itemprop="copyrightYear" content="2023">

  <link rel="icon" href="https://cyborgdream.github.io/images/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="57x57" href="https://cyborgdream.github.io/images/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://cyborgdream.github.io/images/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://cyborgdream.github.io/images/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://cyborgdream.github.io/images/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://cyborgdream.github.io/images/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://cyborgdream.github.io/images/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://cyborgdream.github.io/images/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://cyborgdream.github.io/images/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://cyborgdream.github.io/images/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="https://cyborgdream.github.io/images/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://cyborgdream.github.io/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="https://cyborgdream.github.io/images/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://cyborgdream.github.io/images/favicon-16x16.png">
  <link rel="manifest" href="https://cyborgdream.github.io/images/manifest.json">
  <meta name="msapplication-TileColor" content="black">
  <meta name="msapplication-TileImage" content="https://cyborgdream.github.io/images/ms-icon-144x144.png">
  <meta name="theme-color" content="black">

  <meta property="og:title" content="Do cyborgs dream of bionic sheep? - More C++ concurrency">
  <meta property="og:description" content="20&#x2F;??? We&#x27;re all crazy in different ways, I like C++">
  <meta property="og:url" content="https:&#x2F;&#x2F;cyborgdream.github.io/more-cpp-concurrency">
  <meta property="og:site_name" content="Do cyborgs dream of bionic sheep?">
  
  <meta property="og:image" content="">
  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:site" content="mari_meir">
  <meta name="twitter:creator" content="mari_meir">
  <meta name="twitter:image:alt" content="Do cyborgs dream of bionic sheep?">
  

  
</head>

<body data-spy="scroll" data-target=".bs-docs-sidebar">
  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"></button>
            <a class="brand" href="https:&#x2F;&#x2F;cyborgdream.github.io">Do cyborgs dream of bionic sheep?</a>
            <div class="nav-collapse collapse">
              <ul class="nav">
                
                
                <li class="">
                  <a href="https:&#x2F;&#x2F;cyborgdream.github.io/"><span>Home</span></a>
                </li>
                
                <li class="">
                  <a href="https:&#x2F;&#x2F;cyborgdream.github.io/categories"><span>Categories</span></a>
                </li>
                
                <li class="">
                  <a href="https:&#x2F;&#x2F;cyborgdream.github.io/tags"><span>Tags</span></a>
                </li>
                
                <li class="">
                  <a href="https:&#x2F;&#x2F;cyborgdream.github.io/about"><span>About</span></a>
                </li>
                
                
              </ul>
            </div>
        </div>
    </div>
  </nav>

  <div class="container navmargin">
    <header class="jumbotron subhead" id="overview">
      
<p class="lead">
  <span>&gt;&gt;</span>
  <a href="https:&#x2F;&#x2F;cyborgdream.github.io">Home</a>
  
    <span class="divider">/</span>
    <a class="category" href="https://cyborgdream.github.io/categories/journal/">journal</a>
    <span class="divider">/</span>
      
        <a href="https://cyborgdream.github.io/tags/cpp/">cpp</a>,
      
        <a href="https://cyborgdream.github.io/tags/learning/">learning</a>,
      
        <a href="https://cyborgdream.github.io/tags/security/">security</a>
      
  
</p>

      
<div class="page-header">
  <h1>More C++ concurrency</h1>
</div>

      
<p class="text-right">
  <span class="label label-success">
    &becaus;
    
      Mari-chan
    
  </span>
  <span class="label label-success">&there4; 2022-02-10</span>
  <span class="label label-success">&infin; 5'</span>
</p>

    </header>
    
    <div class="row-fluid">

      <div class="span9 bs-docs-sidebar">
      
<p>Continuing yesterday... Hard day to focus on stuff. Don't feel like I got a lot done, but what can you do!</p>
<h3 id="more-concurrency-baby">More concurrency baby</h3>
<p>When copy constructors are marked as delete it's ensured that they're not automatically provided by the compiler.</p>
<p>Calling <code>detach()</code> on a thread will leave it running on the background (daemon thread, ownership and control are passed over to the C++ Runtime Library. That makes a thread no longer joinable. Can be safe checked using the <code>joinable()</code> method.</p>
<p>Because of the risk of not being able to convert a <code>char*</code> to string on the right time (and avoiding dangling pointers) is better to cast it so string before passing the buffer to <code>std::thread</code>. So, instead of <code>std::thread t(f, 3, buffer);</code> do <code>std::thread t(f, 3, std::string(buffer);</code> with <code>char buffer[1024];</code>.</p>
<p>Sometimes you might want to pass stuff by reference to a thread, the problem is that they're oblivious to types of arguments expected by a function, they just blindly copy stuff. TO fix this, is necessary to wrap elements that need to be reference with <code>std::ref(data)</code>.</p>
<p>When an object is moved in the thread context, the original object is &quot;empty&quot;, using move semantics to move stuff to a <code>std::unique_ptr</code> leave the source obj. with a <code>nlptr</code>.</p>
<p>You can transfer ownership of threads, by using move semantics.</p>
<p><code>std::thread::hardware_concurrency()</code> will show you how many CPU cores are available to truly run cuncurrent threads. <code>std::accumulate</code> divides the work among the threads.</p>
<p>Identifying threads can be done using <code>std::thread::id</code>.</p>
<h4 id="problems-with-sharing-data">Problems with sharing data</h4>
<p>Invariant -&gt; a statement that's always true about a particular data structure, e.g this var contains the number of items in the list.</p>
<p>Race condition: there are several ways to avoid it, the simplest is by wraping your data with a protection mechanism. You can use lock-free programming or mutexes (mutual exclusion). You lock a piece of data and once you're finished, you unlock it. They're not a silver bullet as they have their own issues like deadlocks.</p>
<p>Instead of locking and unlocking a thread manually it's recommended to use <code>std::lock_guard</code>, which is RAII for mutexes. Here's a simple example of use:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>std::mutex m;//you can use std::lock_guard if you want to be exception safe 
</span><span>int i = 0; 
</span><span>void makeACallFromPhoneBooth() 
</span><span>{
</span><span>
</span><span>    //The other men wait outside 
</span><span>    m.lock();// one man gets a hold of the phone booth door and locks it. 
</span><span>      //man happily talks to his wife from now....
</span><span>      std::cout &lt;&lt; i &lt;&lt; &quot; Hello Wife&quot; &lt;&lt; std::endl;
</span><span>      i++;//no other thread can access variable i until m.unlock() is called
</span><span>      //...until now, with no interruption from other men
</span><span>    m.unlock();//man unlocks the phone booth door 
</span><span>}
</span><span>
</span><span>int main() 
</span><span>{
</span><span>    //This is the main crowd of people uninterested in making a phone call
</span><span>
</span><span>    //man1 leaves the crowd to go to the phone booth
</span><span>    std::thread man1(makeACallFromPhoneBooth);
</span><span>    //Although man2 appears to start second, there&#39;s a good chance he might
</span><span>    //reach the phone booth before man1
</span><span>    std::thread man2(makeACallFromPhoneBooth);
</span><span>    //And hey, man3 also joined the race to the booth
</span><span>    std::thread man3(makeACallFromPhoneBooth);
</span><span>
</span><span>    man1.join();//man1 finished his phone call and joins the crowd
</span><span>    man2.join();//man2 finished his phone call and joins the crowd
</span><span>    man3.join();//man3 finished his phone call and joins the crowd
</span><span>    return 0;
</span><span>}
</span></code></pre>
<p>If you allow reference data to be called outside the scope of a lock, is bad! Because people can do some injection in your data:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>class some_data
</span><span>{
</span><span>int a;
</span><span>    std::string b;
</span><span>public:
</span><span>    void do_something();
</span><span>};
</span><span>class data_wrapper
</span><span>{
</span><span>private:
</span><span>    some_data data;
</span><span>    std::mutex m;
</span><span>public:
</span><span>    template&lt;typename Function&gt;
</span><span>    void process_data(Function func)
</span><span>    {
</span><span>        std::lock_guard&lt;std::mutex&gt; l(m);
</span><span>        func(data);
</span><span>    }
</span><span>};
</span><span>some_data* unprotected;
</span><span>void malicious_function(some_data&amp; protected_data)
</span><span>{
</span><span>    unprotected=&amp;protected_data;
</span><span>}
</span><span>data_wrapper x;
</span><span>void foo() {
</span><span>    x.process_data(malicious_function);
</span><span>    unprotected-&gt;do_something();
</span><span>}
</span></code></pre>
<p>So, deadlocking something is when one thread locks one data that the other thread needs and/or vice-versa. The common advice for avoiding deadlock is to always lock the two mutexes is the same order: if you always lock mutex A before B, then you'll never deadlock. We can use the <code>std::lock</code> function that allows you to lock two or more mutexes at once without risking deadlocks. Here are some other tips:</p>
<ul>
<li>
<p>avoid nested locks</p>
</li>
<li>
<p>avoid calling user supplied code while holding a lock</p>
</li>
<li>
<p>acquire locks in a fixed order (this is a very bad advise, your code shouldn't depend on order, LOL)</p>
</li>
<li>
<p>use a lock hierarchy
using something like &quot;high level mutex&quot;, &quot;low level mutex&quot;</p>
</li>
</ul>
<h4 id="some-random-stuff">Some random stuff</h4>
<ul>
<li>
<p>weak_pointers are mainly useful to treat cases of cyclical reference;</p>
</li>
<li>
<p>default constructor, equivalent to empty constructor. It's good for initializing trivial objects or primitive types</p>
</li>
<li>
<p>default destructor, equivalent to empty destructor. calls the superclass destructor</p>
</li>
<li>
<p>copy assignment operators... here's a crazy issue that this thing brings:</p>
</li>
</ul>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>class Buffer {
</span><span>    public:
</span><span>        Beffuer(int size, int* buffer) : size(size), buffer(buffer) {}
</span><span>
</span><span>        int size;
</span><span>        int* buffer;
</span><span>};
</span><span>
</span><span>const int kBufSize = 2;
</span><span>int* buffer = new int[kBufSize]{1, 2};
</span><span>
</span><span>Buffer b1 = Buffer(kBufSize, buffer);
</span><span>
</span><span>Buffer b2 = b1;
</span><span>b2.buffer[0] = -2;
</span></code></pre>
<p>So if we print <code>b1.buffer[0</code> we'll get -2! Because this copy assignment operator is copying the pointer to b2. C++ is crazy broken language.</p>



      </div> <!-- span9 -->

      <div class="span3 bs-docs-sidebar">
      
        <h1>Search</h1>
        <form class="form-search">
          <input id="search" type="text" class="input-large search-query">
        </form>
        <div class="search-results">
          <div class="search-results__items"></div>
        </div>
        <p></p>
        <h1>Categories</h1>
        <ul class="nav nav-list bs-docs-sidenav">
          
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/categories/activism">activism</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/categories/journal">journal</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/categories/research">research</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/categories/tutorial">tutorial</a></li>
          
        </ul>
        <p></p>
        <h1>Tags</h1>
        <ul class="nav nav-list bs-docs-sidenav">        
          
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/tags/ai">ai</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/tags/art">art</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/tags/books">books</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/tags/community">community</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/tags/counter-culture">counter-culture</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/tags/cpp">cpp</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/tags/data">data</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/tags/design">design</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/tags/electronics">electronics</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/tags/js">js</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/tags/learning">learning</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/tags/lisp">lisp</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/tags/love">love</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/tags/performance">performance</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/tags/privacy">privacy</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/tags/python">python</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/tags/rust">rust</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/tags/security">security</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/tags/software-tools">software-tools</a></li>
          
            <li><a href="https:&#x2F;&#x2F;cyborgdream.github.io/tags/web-dev">web-dev</a></li>
              
        </ul>
      
      </div>

    </div> <!-- row -->
  </div> <!-- container navmargin -->

  <footer class="container">
    <hr class="soften">
    <p>
        2023 &copy;
        <a href="https:&#x2F;&#x2F;cyborgdream.github.io">Mari-chan</a>
        |
        
        <a href="https://twitter.com/mari_meir" target="_blank">Twitter</a>
        
        
        <a href="https://linkedin.com/in/mariana-meireles" target="_blank">Linkedin</a>
        
        
        <a href="https://github.com/marimeireles" target="_blank">GitHub</a>
        
        
        |
        Built on <a href="https://getzola.org" target="_blank">Zola</a>
    </p>
  </footer>

  <script src="https://cyborgdream.github.io/js/jquery.js"></script>
  <script src="https://cyborgdream.github.io/js/bootstrap-386.js"></script>
  <script src="https://cyborgdream.github.io/js/bootstrap-transition.js"></script>
  <script src="https://cyborgdream.github.io/js/bootstrap-alert.js"></script>
  <script src="https://cyborgdream.github.io/js/bootstrap-modal.js"></script>
  <script src="https://cyborgdream.github.io/js/bootstrap-dropdown.js"></script>
  <script src="https://cyborgdream.github.io/js/bootstrap-scrollspy.js"></script>
  <script src="https://cyborgdream.github.io/js/bootstrap-tab.js"></script>
  <script src="https://cyborgdream.github.io/js/bootstrap-tooltip.js"></script>
  <script src="https://cyborgdream.github.io/js/bootstrap-popover.js"></script>
  <script src="https://cyborgdream.github.io/js/bootstrap-button.js"></script>
  <script src="https://cyborgdream.github.io/js/bootstrap-collapse.js"></script>
  <script src="https://cyborgdream.github.io/js/bootstrap-carousel.js"></script>
  <script src="https://cyborgdream.github.io/js/bootstrap-typeahead.js"></script>
  <script src="https://cyborgdream.github.io/js/bootstrap-affix.js"></script>
  <script src="https://cyborgdream.github.io/js/zola.386.js"></script>
  <script src="https://cyborgdream.github.io/js/search.js"></script>
  <script src="https://cyborgdream.github.io/elasticlunr.min.js"></script>
  <script src="https://cyborgdream.github.io/search_index.en.js"></script>
</body>
</html>
